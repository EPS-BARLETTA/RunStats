<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Course - RunStats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{--border:#e5e7eb}
    *{box-sizing:border-box}
    body{
      background:#dfeeff; /* Couleur coureur 1 par défaut; le JS passe en vert pour le 2 */
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
      margin:0; padding:24px;
    }
    .wrap{max-width:820px; margin:0 auto; text-align:center}
    h2#title{margin:10px 0 16px}

    /* Minuteur rond */
    .timerWrap{position:relative; width:240px; height:240px; margin:0 auto 10px}
    .ring{width:240px; height:240px; transform:rotate(-90deg)}
    #ringBG{fill:none; stroke:#eef2f7; stroke-width:14}
    #ringFG{fill:none; stroke:#111; stroke-width:14; stroke-linecap:round;
            stroke-dasharray:1; stroke-dashoffset:0; transition:stroke-dashoffset .25s linear}
    .timerText{position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
               font-size:40px; font-weight:800}
    .danger #ringFG{stroke:#e11d48; animation:blink 1s step-start infinite}
    @keyframes blink{50%{opacity:.25}}

    .row{display:flex; justify-content:center; gap:18px; flex-wrap:wrap}
    .data{background:#fff; padding:12px 16px; border-radius:12px; border:1px solid var(--border); min-width:160px}

    /* Boutons */
    .btns{margin-top:16px}
    button{padding:12px 16px; border:1px solid var(--border); border-radius:12px; cursor:pointer;
           background:#111; color:#fff; font-weight:700}
    #nextBtn,#summaryBtn{display:none}

    /* Ajouts discrets pour répondre à ta demande */
    .startWrap{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:12px 0 18px 0;
    }
    .startBtn{
      width:110px; height:110px;
      border-radius:9999px; /* rond */
      border:2px solid currentColor;
      background:#fff; color:#111;
      font-size:1.25rem; font-weight:800;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      cursor:pointer;
    }
    .startBtn:active{ transform:scale(.98) }

    /* +1 tour agrandi pour le confort */
    #lapBtn{
      min-width:140px;
      min-height:56px;
      font-size:1.15rem;
    }

    footer{margin-top:24px; opacity:.7; text-align:center}
    dialog{padding:16px; border-radius:12px; max-width:360px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2 id="title">Course</h2>

    <!-- Minuteur rond -->
    <div class="timerWrap" id="ringWrap" aria-live="polite">
      <svg viewBox="0 0 220 220" class="ring" aria-hidden="true">
        <circle cx="110" cy="110" r="96" id="ringBG"></circle>
        <circle cx="110" cy="110" r="96" id="ringFG"></circle>
      </svg>
      <div id="timer" class="timerText">00:00</div>
    </div>

    <!-- Bouton START (distinct de +1 tour) -->
    <div class="startWrap">
      <button id="startBtn" type="button" class="startBtn">Start</button>
    </div>

    <!-- Indicateurs -->
    <div class="row" style="margin:12px 0 18px">
      <div class="data">Tours : <span id="laps">0</span></div>
      <div class="data">Distance : <span id="distance">0</span> m</div>
      <div class="data">Vitesse : <span id="vitesse">0.00</span> km/h</div>
      <div class="data">Estimation VMA : <span id="vma">0.00</span> km/h</div>
    </div>

    <!-- Boutons -->
    <div class="btns">
      <button id="lapBtn">+ 1 tour</button>
      <button id="nextBtn">Passer au coureur 2</button>
      <button id="summaryBtn">Passer au résumé</button>
    </div>
  </div>

  <!-- Fraction de tour -->
  <dialog id="partialDialog">
    <form method="dialog" style="margin:0">
      <h3 style="margin:0 0 8px">Ajouter un tour partiel ?</h3>
      <p id="partialDialogInfo" style="margin:0 0 12px;opacity:.8"></p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start">
        <button value="0.25">+ 1/4</button>
        <button value="0.5">+ 1/2</button>
        <button value="0.75">+ 3/4</button>
        <button value="0" style="margin-left:auto">Non</button>
      </div>
    </form>
  </dialog>

  <footer>RunStats - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>

  <!-- Scripts (avec cache-buster) -->
  <script src="fraction.js?v=20250810-7"></script>
  <script src="course.js?v=20250810-7"></script>

  <!-- Petit script d’intégration : Start distinct, Next sans autostart -->
  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      // On lit autostart mais on ne déclenche rien ici : démarrage uniquement via le bouton Start.
      const autostart = params.get('autostart') !== '0';

      const startBtn = document.getElementById('startBtn');
      const nextBtn  = document.getElementById('nextBtn');

      // START : si le code d’origine expose une fonction de départ, on l’appelle.
      // Sinon on émet un évènement custom que course.js peut écouter si besoin.
      startBtn?.addEventListener('click', () => {
        if (typeof window.startCourse === 'function') {
          window.startCourse();
        } else {
          document.dispatchEvent(new CustomEvent('runstats:start'));
        }
      });

      // NEXT : accéder au coureur 2 sans démarrer sa course
      nextBtn?.addEventListener('click', (e) => {
        e.preventDefault();
        try { sessionStorage.setItem('runstats_runner','2'); } catch(_) {}
        window.location.href = 'course.html?runner=2&autostart=0';
      });
    })();
  </script>

  <!-- Moteur "chiffres uniquement" (inertiel ici ; actif dès qu’un input a data-digits-only) -->
  <script>
    (() => {
      const SEL = '[data-digits-only]';
      const onlyDigits = v => (v || '').toString().replace(/[^\d]/g, '');

      // Bloque l'insertion de caractères non numériques (clavier virtuel inclus)
      document.addEventListener('beforeinput', (e) => {
        const el = e.target;
        if (!el || !el.matches?.(SEL)) return;
        if (e.data && /\D/.test(e.data)) e.preventDefault();
      }, { capture: true });

      // Nettoie en direct (si un caractère non numérique passe)
      document.addEventListener('input', (e) => {
        const el = e.target;
        if (!el || !el.matches?.(SEL)) return;
        const before = el.value;
        const after  = onlyDigits(before);
        if (before !== after) {
          const delta = before.length - after.length;
          const pos = el.selectionStart;
          el.value = after;
          if (pos != null) {
            const caret = Math.max(0, pos - delta);
            el.setSelectionRange(caret, caret);
          }
        }
      });

      // Nettoie le collage (colle uniquement les chiffres)
      document.addEventListener('paste', (e) => {
        const el = e.target;
        if (!el || !el.matches?.(SEL)) return;
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const ins  = onlyDigits(text);
        const start = el.selectionStart ?? el.value.length;
        const end   = el.selectionEnd ?? el.value.length;
        el.value = el.value.slice(0, start) + ins + el.value.slice(end);
        const caret = start + ins.length;
        el.setSelectionRange(caret, caret);
      });
    })();
  </script>
</body>
</html>
