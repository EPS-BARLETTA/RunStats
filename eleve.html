<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Course Élèves</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Formulaire côte à côte */
  #form-eleves {
    display: flex;
    gap: 40px;
    margin-bottom: 30px;
  }
  .eleve-form {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
    width: 280px;
  }
  .eleve-form h3 {
    margin-top: 0;
    color: #004080;
    text-align: center;
  }
  .eleve-form label {
    display: block;
    margin: 8px 0 3px;
    font-weight: 600;
    color: #003366;
  }
  .eleve-form input, .eleve-form select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* Section paramètres course */
  #params-course {
    margin-bottom: 40px;
    background: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
    width: 600px;
  }
  #params-course label {
    font-weight: 600;
    color: #003366;
    margin-right: 15px;
  }
  #params-course input {
    width: 100px;
    padding: 6px 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    margin-right: 25px;
  }

  /* Conteneur central */
  #course-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 320px;
    position: relative;
  }

  /* Minuteur cercle */
  #minuteur {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    border: 8px solid #004080;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 4rem;
    font-weight: 700;
    color: #004080;
    user-select: none;
    transition: color 0.3s ease;
  }

  /* Clignotement quand reste 10s */
  .warning {
    animation: blinkRed 1s infinite;
    color: red !important;
    border-color: red !important;
  }
  @keyframes blinkRed {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
  }

  /* Boutons au-dessus du minuteur */
  #controls {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
  }
  #controls button {
    background: #0077cc;
    border: none;
    color: white;
    font-weight: 700;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  #controls button:hover:not(:disabled) {
    background: #005999;
  }
  #controls button:disabled {
    background: #cccccc;
    cursor: not-allowed;
  }

  /* Infos de course sous le minuteur */
  #infos-course {
    margin-top: 20px;
    width: 320px;
    background: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 3px 8px rgb(0 0 0 / 0.1);
    color: #003366;
    font-weight: 600;
    line-height: 1.6;
  }

  /* Fin course - fractions de tour */
  #fin-course-controls {
    margin-top: 25px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  #fin-course-controls button {
    background: #28a745;
    border: none;
    color: white;
    font-weight: 700;
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  #fin-course-controls button:hover {
    background: #1e7e34;
  }

  /* Footer actions final */
  #final-actions {
    margin-top: 40px;
    display: flex;
    gap: 20px;
  }
  #final-actions button {
    background: #004080;
    border: none;
    color: white;
    font-weight: 700;
    padding: 12px 22px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.25s ease;
  }
  #final-actions button:hover {
    background: #00264d;
  }
</style>
</head>
<body>

<!-- Formulaire élève côte à côte -->
<div id="form-eleves">
  <form class="eleve-form" id="eleve1-form" autocomplete="off">
    <h3>Élève 1 (Course 1)</h3>
    <label for="nom1">Nom :</label>
    <input type="text" id="nom1" required />
    <label for="prenom1">Prénom :</label>
    <input type="text" id="prenom1" required />
    <label for="classe1">Classe :</label>
    <input type="text" id="classe1" />
    <label for="sexe1">Sexe :</label>
    <select id="sexe1" required>
      <option value="">-- Choisir --</option>
      <option value="M">Masculin</option>
      <option value="F">Féminin</option>
      <option value="Autre">Autre</option>
    </select>
  </form>

  <form class="eleve-form" id="eleve2-form" autocomplete="off">
    <h3>Élève 2 (Course 2)</h3>
    <label for="nom2">Nom :</label>
    <input type="text" id="nom2" required />
    <label for="prenom2">Prénom :</label>
    <input type="text" id="prenom2" required />
    <label for="classe2">Classe :</label>
    <input type="text" id="classe2" />
    <label for="sexe2">Sexe :</label>
    <select id="sexe2" required>
      <option value="">-- Choisir --</option>
      <option value="M">Masculin</option>
      <option value="F">Féminin</option>
      <option value="Autre">Autre</option>
    </select>
  </form>
</div>

<!-- Paramètres course -->
<div id="params-course">
  <label for="duree">Durée (minutes) :</label>
  <input type="number" id="duree" min="1" max="120" value="6" />
  <label for="distanceTour">Distance tour (mètres) :</label>
  <input type="number" id="distanceTour" min="10" value="400" />
  <label for="vma">VMA estimée (km/h) :</label>
  <input type="number" id="vma" min="5" max="25" step="0.1" value="12" />
</div>

<!-- Contrôles et minuteur -->
<div id="course-container" style="display:none;">
  <div id="controls">
    <button id="demarrer">Démarrer la course 1</button>
    <button id="plusTour" disabled>+ Tour</button>
    <button id="reset">Reset</button>
  </div>

  <div id="minuteur">00:00</div>

  <div id="infos-course">
    <div id="coureur-nom"></div>
    <div id="distanceParcourue">Distance parcourue: 0 m</div>
    <div id="vitesse">Vitesse: 0 km/h</div>
    <div id="vmaEstimee">VMA estimée: 0 km/h</div>
    <div id="nombreTours">Nombre de tours: 0</div>
  </div>

  <!-- Contrôles fin course (fractions) -->
  <div id="fin-course-controls" style="display:none;">
    <button data-fraction="0.25">+ 1/4 tour</button>
    <button data-fraction="0.5">+ 1/2 tour</button>
    <button data-fraction="0.75">+ 3/4 tour</button>
    <button id="fin-course-suivant" style="background:#004080;">Passer à la course suivante</button>
  </div>
</div>

<!-- Actions finales -->
<div id="final-actions" style="display:none;">
  <button id="genQRCode">Générer QR Code</button>
  <button id="exportCsv">Exporter CSV</button>
</div>

<!-- QR Code container -->
<div id="qrCodeContainer" style="margin-top:30px;"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // Variables globales
  let duree, distanceTour, vmaInput;
  let tempsRestant = 0;
  let timerInterval = null;
  let tours = 0;
  let fractionTourAjoutee = 0;
  let currentCourse = 1; // 1 ou 2
  let eleve1Data = { nom: '', prenom: '', classe: '', sexe: '' };
  let eleve2Data = { nom: '', prenom: '', classe: '', sexe: '' };
  let dataCourse1 = null;
  let dataCourse2 = null;

  // DOM
  const demarrerBtn = document.getElementById('demarrer');
  const plusTourBtn = document.getElementById('plusTour');
  const resetBtn = document.getElementById('reset');
  const minuteurDisplay = document.getElementById('minuteur');
  const courseContainer = document.getElementById('course-container');
  const coureurNomDisplay = document.getElementById('coureur-nom');
  const distanceParcourueDisplay = document.getElementById('distanceParcourue');
  const vitesseDisplay = document.getElementById('vitesse');
  const vmaEstimeeDisplay = document.getElementById('vmaEstimee');
  const nombreToursDisplay = document.getElementById('nombreTours');
  const finCourseControls = document.getElementById('fin-course-controls');
  const finCourseBtns = finCourseControls.querySelectorAll('button[data-fraction]');
  const finCourseSuivantBtn = document.getElementById('fin-course-suivant');
  const finalActions = document.getElementById('final-actions');
  const genQRCodeBtn = document.getElementById('genQRCode');
  const exportCsvBtn = document.getElementById('exportCsv');
  const qrCodeContainer = document.getElementById('qrCodeContainer');

  // Form inputs élève
  const nom1Input = document.getElementById('nom1');
  const prenom1Input = document.getElementById('prenom1');
  const classe1Input = document.getElementById('classe1');
  const sexe1Input = document.getElementById('sexe1');

  const nom2Input = document.getElementById('nom2');
  const prenom2Input = document.getElementById('prenom2');
  const classe2Input = document.getElementById('classe2');
  const sexe2Input = document.getElementById('sexe2');

  // Params inputs
  const dureeInput = document.getElementById('duree');
  const distanceTourInput = document.getElementById('distanceTour');
  const vmaInputInput = document.getElementById('vma');

  // Format time mm:ss
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  }

  // Start timer
  function startTimer() {
    tempsRestant = duree * 60;
    updateTimerDisplay();
    minuteurDisplay.classList.remove('warning');
    timerInterval = setInterval(() => {
      tempsRestant--;
      updateTimerDisplay();
      if (tempsRestant <= 10) {
        minuteurDisplay.classList.add('warning');
      }
      if (tempsRestant <= 0) {
        clearInterval(timerInterval);
        finCourse();
      }
    }, 1000);
  }

  // Update timer display
  function updateTimerDisplay() {
    minuteurDisplay.textContent = formatTime(tempsRestant);
  }

  // Update infos course
  function updateCourseDetails() {
    const distanceParcourue = (tours + fractionTourAjoutee) * distanceTour;
    const tempsEcoule = (duree * 60) - tempsRestant;

    // vitesse moyenne en km/h
    const vitesse = tempsEcoule > 0 ? (distanceParcourue / tempsEcoule) * 3.6 : 0;

    distanceParcourueDisplay.textContent = `Distance parcourue: ${distanceParcourue.toFixed(2)} m`;
    vitesseDisplay.textContent = `Vitesse: ${vitesse.toFixed(2)} km/h`;
    vmaEstimeeDisplay.textContent = `VMA estimée: ${vitesse.toFixed(2)} km/h`;
    nombreToursDisplay.textContent = `Nombre de tours: ${(tours + fractionTourAjoutee).toFixed(2)}`;
  }

  // Reset complet
  function resetAll() {
    clearInterval(timerInterval);
    tempsRestant = 0;
    tours = 0;
    fractionTourAjoutee = 0;
    currentCourse = 1;
    dataCourse1 = null;
    dataCourse2 = null;
    eleve1Data = { nom: '', prenom: '', classe: '', sexe: '' };
    eleve2Data = { nom: '', prenom: '', classe: '', sexe: '' };

    // Reset inputs
    nom1Input.value = '';
    prenom1Input.value = '';
    classe1Input.value = '';
    sexe1Input.value = '';

    nom2Input.value = '';
    prenom2Input.value = '';
    classe2Input.value = '';
    sexe2Input.value = '';

    dureeInput.value = 6;
    distanceTourInput.value = 400;
    vmaInputInput.value = 12;

    demarrerBtn.textContent = 'Démarrer la course 1';
    demarrerBtn.disabled = false;
    plusTourBtn.disabled = true;
    finCourseControls.style.display = 'none';
    courseContainer.style.display = 'none';
    finalActions.style.display = 'none';
    qrCodeContainer.innerHTML = '';
    minuteurDisplay.textContent = '00:00';
    minuteurDisplay.classList.remove('warning');
    coureurNomDisplay.textContent = '';
    distanceParcourueDisplay.textContent = 'Distance parcourue: 0 m';
    vitesseDisplay.textContent = 'Vitesse: 0 km/h';
    vmaEstimeeDisplay.textContent = 'VMA estimée: 0 km/h';
    nombreToursDisplay.textContent = 'Nombre de tours: 0';
  }

  // Fin course - afficher boutons ajout fraction + bouton suivant
  function finCourse() {
    clearInterval(timerInterval);
    demarrerBtn.disabled = true;
    plusTourBtn.disabled = true;
    finCourseControls.style.display = 'flex';
  }

  // Valider formulaire élève
  function validerEleve(form) {
    const nom = form.querySelector('input[type=text]').value.trim();
    const prenom = form.querySelectorAll('input[type=text]')[1].value.trim();
    const sexe = form.querySelector('select').value;
    return nom && prenom && sexe;
  }

  // Récupérer données élève
  function getEleveData(form) {
    return {
      nom: form.querySelector('input[type=text]').value.trim(),
      prenom: form.querySelectorAll('input[type=text]')[1].value.trim(),
      classe: form.querySelectorAll('input[type=text]')[2].value.trim(),
      sexe: form.querySelector('select').value
    };
  }

  // Lancer course (1 ou 2)
  function lancerCourse() {
    // Vérifier formulaire de l'élève courant
    const form = currentCourse === 1 ? document.getElementById('eleve1-form') : document.getElementById('eleve2-form');
    if (!validerEleve(form)) {
      alert(`Merci de remplir correctement le formulaire de l'élève ${currentCourse}`);
      return;
    }

    // Récupérer paramètres
    duree = parseInt(dureeInput.value);
    distanceTour = parseFloat(distanceTourInput.value);
    vmaInput = parseFloat(vmaInputInput.value);

    // Récupérer données élève courant
    if (currentCourse === 1) {
      eleve1Data = getEleveData(form);
      coureurNomDisplay.textContent = `Coureur : ${eleve1Data.nom} ${eleve1Data.prenom}`;
    } else {
      eleve2Data = getEleveData(form);
      coureurNomDisplay.textContent = `Coureur : ${eleve2Data.nom} ${eleve2Data.prenom}`;
    }

    // Masquer formulaire, afficher course container
    document.getElementById('form-eleves').style.display = 'none';
    document.getElementById('params-course').style.display = 'none';
    courseContainer.style.display = 'flex';

    // Initialiser états
    tours = 0;
    fractionTourAjoutee = 0;
    tempsRestant = duree * 60;
    updateTimerDisplay();
    minuteurDisplay.classList.remove('warning');
    demarrerBtn.disabled = true;
    plusTourBtn.disabled = false;
    finCourseControls.style.display = 'none';

    startTimer();
  }

  // Ajouter un tour complet
  plusTourBtn.addEventListener('click', () => {
    tours++;
    updateCourseDetails();
  });

  // Boutons fin course (ajout fraction)
  finCourseBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const frac = parseFloat(btn.getAttribute('data-fraction'));
      fractionTourAjoutee += frac;
      updateCourseDetails();
    });
  });

  // Passer à course suivante (après fin course 1)
  finCourseSuivantBtn.addEventListener('click', () => {
    // Sauvegarder données course 1 ou 2
    const distanceTotale = (tours + fractionTourAjoutee) * distanceTour;
    const tempsEcoule = duree * 60;
    const vitesseMoyenne = distanceTotale > 0 ? (distanceTotale / tempsEcoule) * 3.6 : 0;

    if (currentCourse === 1) {
      dataCourse1 = {
        eleve: eleve1Data,
        distanceTotale,
        vitesseMoyenne,
        vmaEstimee: vitesseMoyenne,
        tours: tours + fractionTourAjoutee
      };
      // Lancer course 2
      currentCourse = 2;
      demarrerBtn.textContent = 'Démarrer la course 2';
      demarrerBtn.disabled = false;
      plusTourBtn.disabled = true;
      finCourseControls.style.display = 'none';
      tours = 0;
      fractionTourAjoutee = 0;
      tempsRestant = 0;
      minuteurDisplay.textContent = '00:00';
      coureurNomDisplay.textContent = '';
      distanceParcourueDisplay.textContent = 'Distance parcourue: 0 m';
      vitesseDisplay.textContent = 'Vitesse: 0 km/h';
      vmaEstimeeDisplay.textContent = 'VMA estimée: 0 km/h';
      nombreToursDisplay.textContent = 'Nombre de tours: 0';
    } else {
      // Sauvegarder course 2
      dataCourse2 = {
        eleve: eleve2Data,
        distanceTotale,
        vitesseMoyenne,
        vmaEstimee: vitesseMoyenne,
        tours: tours + fractionTourAjoutee
      };

      // Fin du process, afficher boutons QR et CSV
      courseContainer.style.display = 'none';
      finalActions.style.display = 'flex';
    }
  });

  // Bouton démarrer
  demarrerBtn.addEventListener('click', (e) => {
    e.preventDefault();
    lancerCourse();
  });

  // Bouton reset
  resetBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if(confirm('Voulez-vous vraiment réinitialiser toutes les données ?')) {
      resetAll();
      document.getElementById('form-eleves').style.display = 'flex';
      document.getElementById('params-course').style.display = 'block';
    }
  });

  // Générer QR Code (contenant résumé des 2 courses)
  genQRCodeBtn.addEventListener('click', () => {
    qrCodeContainer.innerHTML = '';
    if (!dataCourse1 || !dataCourse2) {
      alert('Les données des deux courses ne sont pas complètes.');
      return;
    }
    const qrText = JSON.stringify({ course1: dataCourse1, course2: dataCourse2 });
    QRCode.toCanvas(qrText, { width: 200 }, function (error, canvas) {
      if (error) {
        alert('Erreur génération QR Code.');
        console.error(error);
        return;
      }
      qrCodeContainer.appendChild(canvas);
    });
  });

  // Export CSV
  exportCsvBtn.addEventListener('click', () => {
    if (!dataCourse1 || !dataCourse2) {
      alert('Les données des deux courses ne sont pas complètes.');
      return;
    }
    const csvRows = [];
    csvRows.push(['Course','Nom','Prénom','Classe','Sexe','Distance totale (m)','Vitesse moyenne (km/h)','VMA estimée (km/h)','Nombre de tours']);
    [dataCourse1, dataCourse2].forEach((c, i) => {
      csvRows.push([
        `Course ${i+1}`,
        c.eleve.nom,
        c.eleve.prenom,
        c.eleve.classe,
        c.eleve.sexe,
        c.distanceTotale.toFixed(2),
        c.vitesseMoyenne.toFixed(2),
        c.vmaEstimee.toFixed(2),
        c.tours.toFixed(2)
      ].join(';'));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = 'donnees_courses.csv';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // Initialisation (reset)
  resetAll();
</script>

</body>
</html>
