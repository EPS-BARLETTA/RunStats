<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Résumé de la course</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body { font-family: sans-serif; margin: 20px; }
.eleve { display: inline-block; width: 45%; padding: 10px; margin: 5px; border-radius: 8px; vertical-align: top; }
.eleve h2 { margin-top: 0; }
.bleu { background-color: #cce5ff; }
.vert { background-color: #d4edda; }
#qrcode { margin-top: 20px; }
button { margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
.btn-prof { background-color: orange; color: white; }
.btn-csv { background-color: #007bff; color: white; }
.btn-home { background-color: green; color: white; }
footer { margin-top: 40px; font-size: 14px; opacity: 0.7; }
</style>
</head>
<body>

<h1>Résumé de la course</h1>
<div id="eleve1" class="eleve bleu"></div>
<div id="eleve2" class="eleve vert"></div>

<div id="qrcode"></div>
<br>
<button class="btn-prof" id="btnProf">Mode Prof</button>
<button class="btn-csv" id="btnCSV">Exporter CSV</button>
<button class="btn-home" onclick="location.href='index.html'">Accueil</button>

<footer>RunStats - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</footer>

<script>
window.addEventListener('load', function() {
  const PIN_CODE = "57";
  let stats = [];
  const storageStats = sessionStorage.getItem("stats");
  if (storageStats) {
    stats = JSON.parse(storageStats);
  }
  if (!stats.length) {
    document.body.innerHTML += "<p>Aucune donnée trouvée.</p>";
    return;
  }

  function afficherEleve(eleve, elementId) {
    const el = document.getElementById(elementId);
    el.innerHTML = `
      <h2>${eleve.nom} ${eleve.prenom}</h2>
      <p>Classe : ${eleve.classe}</p>
      <p>Sexe : ${eleve.sexe}</p>
      <p>Distance : ${eleve.distance} m</p>
      <p>Vitesse : ${parseFloat(eleve.vitesse).toFixed(2)} km/h</p>
      <p>VMA : ${parseFloat(eleve.vma).toFixed(2)} km/h</p>
    `;
  }

  afficherEleve(stats[0], "eleve1");
  afficherEleve(stats[1], "eleve2");

  function genererQR() {
    document.getElementById("qrcode").innerHTML = "";
    const data = stats.map(e => ({
      nom: e.nom,
      prenom: e.prenom,
      classe: e.classe,
      sexe: e.sexe,
      distance: Number(e.distance),
      vitesse: Number(parseFloat(e.vitesse).toFixed(2)),
      vma: Number(parseFloat(e.vma).toFixed(2))
    }));
    new QRCode(document.getElementById("qrcode"), {
      text: JSON.stringify(data),
      width: 256,
      height: 256
    });
  }
  genererQR();

  document.getElementById("btnProf").addEventListener("click", () => {
    const pin = prompt("Code PIN :");
    if (pin === PIN_CODE) {
      const idx = prompt("Modifier élève (1 ou 2) :");
      if (idx === "1" || idx === "2") {
        const modif = prompt("Ajustement distance (+ ou - en mètres) :");
        const val = parseFloat(modif);
        if (!isNaN(val)) {
          stats[idx-1].distance = Number(stats[idx-1].distance) + val;
          stats[idx-1].vitesse = (stats[idx-1].distance / (stats[idx-1].temps / 60)).toFixed(2);
          stats[idx-1].vma = (stats[idx-1].vitesse / 0.8).toFixed(2);
          sessionStorage.setItem("stats", JSON.stringify(stats));
          afficherEleve(stats[0], "eleve1");
          afficherEleve(stats[1], "eleve2");
          genererQR();
        }
      }
    }
  });

  document.getElementById("btnCSV").addEventListener("click", () => {
    let csv = "Nom;Prénom;Classe;Sexe;Distance;Vitesse;VMA\n";
    stats.forEach(e => {
      csv += `${e.nom};${e.prenom};${e.classe};${e.sexe};${e.distance};${e.vitesse};${e.vma}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "resultats.csv";
    a.click();
    URL.revokeObjectURL(url);
  });
});
</script>

</body>
</html>
